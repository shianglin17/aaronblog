name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    # æ·»åŠ  Redis æœå‹™
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, curl, zip, pdo, sqlite, pdo_sqlite, redis
          tools: composer:v2
      
      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
      
      - name: Install PHP dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
      
      - name: Generate key
        run: php artisan key:generate
      
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
      
      - name: Create SQLite database
        run: |
          mkdir -p database
          touch database/database.sqlite
      
      - name: Execute tests (Unit and Feature tests) via PHPUnit/Pest
        run: php artisan test --testsuite=Feature
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
          # æ·»åŠ  Redis è¨­å®šï¼Œè®“ github action æ¸¬è©¦ç’°å¢ƒä½¿ç”¨ Redis å¿«å–
          CACHE_STORE: redis
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_PASSWORD: null
          REDIS_DATABASE: 0

  build-frontend:
    name: Build Frontend Assets
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Build frontend assets
        run: npm run build
      
      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/build/
          retention-days: 1

  build-docker:
    name: Build/Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: aaronlei17/aaronblog-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Production
    needs: [build-frontend, build-docker]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/build/
      
      - name: Deploy to GCP VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          script: |
            echo "é–‹å§‹éƒ¨ç½²æ–°ç‰ˆæœ¬..."
            
            # é€²å…¥å°ˆæ¡ˆç›®éŒ„
            cd ~/aaronblog
            
            # å»ºç«‹å‚™ä»½
            echo "å»ºç«‹å‰ç«¯è³‡æºå‚™ä»½..."
            if [ -d "public/build" ]; then
              cp -r public/build public/build.backup.$(date +%Y%m%d-%H%M%S)
            fi
            
            # æ‹‰å–æœ€æ–°å¾Œç«¯ç¨‹å¼ç¢¼ï¼ˆå‰ç«¯è³‡æºé€é git pullï¼‰
            echo "æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼..."
            git pull origin main
            
            # æ‹‰å–æœ€æ–° Docker imageï¼ˆé‚„åŸ README æ­¥é©Ÿï¼‰
            echo "æ‹‰å–æœ€æ–° Docker image..."
            docker pull aaronlei17/aaronblog-app:latest
      
      - name: Upload frontend assets
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          source: "public/build/"
          target: "~/aaronblog/public/"
          strip_components: 1
          # è¨»ï¼šåŸå§‹ README æµç¨‹æ˜¯é€é git push åŒ…å«å‰ç«¯è³‡æº
          # ä½†ç‚ºäº†é¿å…åœ¨ repo ä¸­ç”¢ç”Ÿé¡å¤–çš„ commitï¼Œä½¿ç”¨ SCP ä¸Šå‚³
          # æ•ˆæœç›¸åŒï¼šè®“ VM ä¸Šçš„ public/build ç›®éŒ„æœ‰æœ€æ–°çš„å‰ç«¯è³‡æº
      
      - name: Restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          script: |
            echo "é‡å•Ÿæœå‹™..."
            cd ~/aaronblog
            
            # é‡å•Ÿ Docker æœå‹™ï¼ˆé‚„åŸ README æ­¥é©Ÿï¼‰
            docker-compose -f docker-compose.gcp.yml down
            docker-compose -f docker-compose.gcp.yml up -d
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•ï¼ˆå¯ä»¥å¾ 15 ç§’æ¸›å°‘åˆ° 10 ç§’ï¼‰
            echo "ç­‰å¾…æœå‹™å•Ÿå‹•..."
            sleep 10
            
            # é©—è­‰éƒ¨ç½²æˆåŠŸ
            echo "é©—è­‰éƒ¨ç½²ç‹€æ…‹..."
            if docker-compose -f docker-compose.gcp.yml ps | grep -q "Up"; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
              
              # æ¸…ç†èˆŠçš„å‚™ä»½ï¼ˆä¿ç•™æœ€è¿‘3å€‹ï¼‰
              find ~/aaronblog/public -name "build.backup.*" -type d | sort -r | tail -n +4 | xargs rm -rf
              
            else
              echo "âŒ éƒ¨ç½²å¤±æ•—ï¼é–‹å§‹å›æ»¾..."
              
              # å›æ»¾å‰ç«¯è³‡æº
              LATEST_BACKUP=$(find ~/aaronblog/public -name "build.backup.*" -type d | sort -r | head -n 1)
              if [ -n "$LATEST_BACKUP" ]; then
                rm -rf ~/aaronblog/public/build
                cp -r "$LATEST_BACKUP" ~/aaronblog/public/build
                echo "å·²å›æ»¾å‰ç«¯è³‡æº"
              fi
              
              # é‡æ–°å•Ÿå‹•æœå‹™
              docker-compose -f docker-compose.gcp.yml down
              docker-compose -f docker-compose.gcp.yml up -d
              
              sleep 8  # å›æ»¾æ™‚å¯ä»¥ç¨å¾®æ¸›å°‘ç­‰å¾…æ™‚é–“
              
              if docker-compose -f docker-compose.gcp.yml ps | grep -q "Up"; then
                echo "âœ… å›æ»¾æˆåŠŸï¼"
                exit 1
              else
                echo "âŒ å›æ»¾ä¹Ÿå¤±æ•—äº†ï¼è«‹æ‰‹å‹•æª¢æŸ¥ï¼"
                exit 1
              fi
            fi

  notify:
    name: Notify Success
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Notify deployment success
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "âœ… æ¸¬è©¦é€šé"
          echo "âœ… å‰ç«¯æ§‹å»ºå®Œæˆ"
          echo "âœ… Docker æ˜ åƒæ§‹å»ºå®Œæˆ"
          echo "âœ… éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒæˆåŠŸ"
          echo "ğŸ“… éƒ¨ç½²æ™‚é–“: $(date)"

  notify-failure:
    name: Notify Failure
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "âŒ éƒ¨ç½²å¤±æ•—ï¼"
          echo "æ™‚é–“: $(date)"
          echo "æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ä½œè€…: ${{ github.actor }}"
          echo "å¤±æ•—åŸå› : è«‹æª¢æŸ¥ä¸Šè¿°æ­¥é©Ÿçš„æ—¥èªŒ"
          
          # é€™è£¡å¯ä»¥æ·»åŠ æ›´å¤šé€šçŸ¥æ–¹å¼ï¼Œä¾‹å¦‚ï¼š
          # - ç™¼é€ Email
          # - ç™¼é€ Slack æ¶ˆæ¯
          # - ç™¼é€ Discord æ¶ˆæ¯
          # - ç™¼é€æ¨é€é€šçŸ¥ 