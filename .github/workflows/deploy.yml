name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    # æ·»åŠ  Redis æœå‹™
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, curl, zip, pdo, sqlite, pdo_sqlite, redis
          tools: composer:v2
      
      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
      
      - name: Install PHP dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
      
      - name: Generate key
        run: php artisan key:generate
      
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
      
      - name: Create SQLite database
        run: |
          mkdir -p database
          touch database/database.sqlite
      
      - name: Execute tests (Unit and Feature tests) via PHPUnit/Pest
        run: php artisan test --testsuite=Feature
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
          CACHE_STORE: redis
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_PASSWORD: null
          REDIS_DATABASE: 0

  build-frontend:
    name: Build Frontend Assets
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Build frontend assets
        run: npm run build
      
      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/build/
          retention-days: 1

  build-docker:
    name: Build/Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: aaronlei17/aaronblog-app:aws-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to AWS EC2
    needs: [build-frontend, build-docker]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/build/
      
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ é–‹å§‹ AWS EC2 éƒ¨ç½²..."
            
            # é€²å…¥å°ˆæ¡ˆç›®éŒ„
            cd ~/aaronblog
            
            # å»ºç«‹å‚™ä»½
            echo "ğŸ“¦ å»ºç«‹å‰ç«¯è³‡æºå‚™ä»½..."
            if [ -d "public/build" ]; then
              cp -r public/build public/build.backup.$(date +%Y%m%d-%H%M%S)
            fi
            
            # å‰µå»ºå¿…è¦çš„ç›®éŒ„çµæ§‹
            echo "ğŸ“ ç¢ºä¿ç›®éŒ„çµæ§‹æ­£ç¢º..."
            mkdir -p storage/database  # SQLite æ•¸æ“šåº«ç›´æ¥å­˜æ”¾ä½ç½®
            mkdir -p storage/logs
            mkdir -p storage/framework/{cache,sessions,views}
            mkdir -p storage/app
            
            # è¨­ç½®æ­£ç¢ºçš„æ¬Šé™ï¼ˆAWS EC2 å„ªåŒ–ï¼‰
            echo "ğŸ” è¨­ç½®æª”æ¡ˆæ¬Šé™..."
            sudo chown -R $USER:$USER ~/aaronblog
            chmod -R 755 ~/aaronblog
            chmod -R 775 ~/aaronblog/storage
            chmod -R 775 ~/aaronblog/bootstrap/cache
            
            # æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼..."
            git pull origin main
            
            # æ‹‰å– AWS å°ˆç”¨çš„ Docker image
            echo "ğŸ³ æ‹‰å–æœ€æ–° Docker image..."
            docker pull aaronlei17/aaronblog-app:aws-latest
            
            # æ›´æ–° docker-compose ä¸­çš„ image tag
            sed -i 's/aaronlei17\/aaronblog-app:latest/aaronlei17\/aaronblog-app:aws-latest/g' docker-compose.prod.yml
      
      - name: Upload frontend assets
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          source: "public/build/"
          target: "~/aaronblog/public/"
          strip_components: 1
      
      - name: Restart services and health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ”„ é‡å•Ÿ AWS EC2 æœå‹™..."
            cd ~/aaronblog
            
            # åœæ­¢ç¾æœ‰æœå‹™
            docker-compose -f docker-compose.prod.yml down
            
            # æ¸…ç†æœªä½¿ç”¨çš„ Docker è³‡æºï¼ˆAWS EC2 ç£ç›¤ç©ºé–“å„ªåŒ–ï¼‰
            docker system prune -f
            
            # å•Ÿå‹•æ–°æœå‹™
            docker-compose -f docker-compose.prod.yml up -d
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
            sleep 15
            
            # ç°¡å–®å¥åº·æª¢æŸ¥
            echo "ğŸ¥ æª¢æŸ¥æœå‹™ç‹€æ…‹..."
            
            # æª¢æŸ¥å®¹å™¨æ˜¯å¦å•Ÿå‹•
            if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "âœ… å®¹å™¨å•Ÿå‹•æˆåŠŸ"
              
              # ç°¡å–® HTTP æª¢æŸ¥
              if curl -f http://localhost:80 > /dev/null 2>&1; then
                echo "âœ… ç¶²ç«™æœå‹™æ­£å¸¸"
                echo "ğŸ‰ AWS EC2 éƒ¨ç½²æˆåŠŸï¼"
                
                # æ¸…ç†èˆŠå‚™ä»½ï¼ˆåªä¿ç•™1å€‹ï¼‰
                find ~/aaronblog/public -name "build.backup.*" -type d | sort -r | tail -n +2 | xargs rm -rf 2>/dev/null || true
                
              else
                echo "âš ï¸  HTTP æª¢æŸ¥ç•°å¸¸ï¼Œä½†å®¹å™¨å·²å•Ÿå‹•"
                echo "ğŸ” è«‹æ‰‹å‹•æª¢æŸ¥ç¶²ç«™ç‹€æ…‹"
              fi
            else
              echo "âŒ å®¹å™¨å•Ÿå‹•å¤±æ•—ï¼"
              docker-compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi

  notify:
    name: Notify Success
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Notify deployment success
        run: |
          echo "ğŸ‰ AWS EC2 éƒ¨ç½²æˆåŠŸï¼"
          echo "âœ… æ¸¬è©¦é€šé"
          echo "âœ… å‰ç«¯æ§‹å»ºå®Œæˆ"
          echo "âœ… Docker æ˜ åƒæ§‹å»ºå®Œæˆ"
          echo "âœ… éƒ¨ç½²åˆ° AWS EC2 æˆåŠŸ"
          echo "ğŸ“… éƒ¨ç½²æ™‚é–“: $(date)"
          echo "ğŸ·ï¸  Docker Tag: aws-latest"

  notify-failure:
    name: Notify Failure
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "âŒ AWS EC2 éƒ¨ç½²å¤±æ•—ï¼"
          echo "ğŸ• æ™‚é–“: $(date)"
          echo "ğŸ“ æäº¤: ${{ github.sha }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ‘¤ ä½œè€…: ${{ github.actor }}"
          echo "ğŸ” å¤±æ•—åŸå› : è«‹æª¢æŸ¥ä¸Šè¿°æ­¥é©Ÿçš„æ—¥èªŒ"