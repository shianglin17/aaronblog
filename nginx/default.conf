# ========================================
# Nginx 配置 - Cloudflare Proxy 最佳化版本
# ========================================
# 功能：封鎖直接 IP 存取 + 信任 Cloudflare 標頭

# 全域安全：隱藏 Nginx 版本資訊
server_tokens off;

# ========================================
# 預設服務器：封鎖所有直接 IP 和未知域名存取
# ========================================
server {
    listen 80 default_server;
    server_name _;  # 捕獲所有非指定域名的請求
    return 444;     # 直接關閉 TCP 連接（比 403/404 更安全）
}

# ========================================
# 主服務器：只允許正確域名存取
# ========================================
server {
    listen 80;
    server_name aaronlei.com www.aaronlei.com;
    
    root /var/www/public;
    index index.php index.html;
    
    # ========================================
    # Cloudflare 真實 IP 設定（簡化版）
    # ========================================
    # 只信任 Cloudflare 標頭，因為直接 IP 存取已被封鎖
    real_ip_header CF-Connecting-IP;

    # ========================================
    # 靜態資源處理
    # ========================================
    # Vite 建置資源（長期快取）
    location /build/ {
        root /var/www/public;
        try_files $uri =404;
        access_log off;
        expires 1y;
    }

    # 一般靜態資源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1M;
        access_log off;
    }

    # ========================================
    # Laravel 路由處理
    # ========================================
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ========================================
    # PHP 處理（安全配置）
    # ========================================
    location ~ \.php$ {
        # 防止 PHP 代碼注入攻擊
        try_files $uri =404;
        
        # FastCGI 配置
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # 隱藏 PHP 版本資訊（防止版本探測）
        fastcgi_hide_header X-Powered-By;
    }

    # ========================================
    # 服務器層安全防護（Cloudflare 無法處理）
    # ========================================
    # 禁止存取敏感設定檔
    location ~ /\.(htaccess|htpasswd|env|git) {
        deny all;
        return 404;
    }
    
    # 禁止存取 Laravel 內部目錄
    location ~ ^/(vendor|storage|bootstrap|database|config|app)/ {
        deny all;
        return 404;
    }
    
    # ========================================
    # 基本安全限制
    # ========================================
    client_max_body_size 10M;  # 檔案上傳限制
}