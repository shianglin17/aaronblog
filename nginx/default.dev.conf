# ========================================
# Nginx 配置 - 開發環境版本
# ========================================
# 功能：允許 localhost 訪問，適合本地開發

# 全域安全：隱藏 Nginx 版本資訊
server_tokens off;

# ========================================
# 開發環境主服務器：允許 localhost 訪問
# ========================================
server {
    listen 80;
    server_name localhost 127.0.0.1 aaronlei.com www.aaronlei.com;
    
    root /var/www/public;
    index index.php index.html;
    
    # ========================================
    # 靜態資源處理
    # ========================================
    # Vite 建置資源（長期快取）
    location /build/ {
        root /var/www/public;
        try_files $uri =404;
        access_log off;
        expires 1y;
    }

    # 一般靜態資源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1M;
        access_log off;
    }

    # ========================================
    # Laravel 路由處理
    # ========================================
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ========================================
    # PHP 處理（安全配置）
    # ========================================
    location ~ \.php$ {
        # 防止 PHP 代碼注入攻擊
        try_files $uri =404;
        
        # FastCGI 配置
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # 隱藏 PHP 版本資訊（防止版本探測）
        fastcgi_hide_header X-Powered-By;
    }

    # ========================================
    # 開發環境安全防護（相對寬鬆）
    # ========================================
    # 禁止存取敏感設定檔
    location ~ /\.(htaccess|htpasswd|env|git) {
        deny all;
        return 404;
    }
    
    # 禁止存取 Laravel 內部目錄
    location ~ ^/(vendor|storage|bootstrap|database|config|app)/ {
        deny all;
        return 404;
    }
    
    # ========================================
    # 基本安全限制
    # ========================================
    client_max_body_size 10M;  # 檔案上傳限制
    
    # 開發環境友好設定
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    
    # 開發環境錯誤頁面
    error_page 404 /index.php;
    
    # 開發調試標頭
    add_header X-Debug-Environment "development" always;
}